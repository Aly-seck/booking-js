<!DOCTYPE html>
<html>
 <head>
  <meta charset="UTF-8">
  <title>Booking.js single instance example</title>
  <style type="text/css">
    body { background-color: #E6E6E6; max-width: 700px; margin: 0 auto; }
  </style>
 </head>
 <body>

  <script src="https://checkout.stripe.com/checkout.js"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script type="text/javascript" src="../dist/booking.js"></script>
  <div id="bookingjs">
    <script type="text/javascript">

      // When Stripe checkout has been successfully submitted
      window.whenStripeSucceeds = function(token) {
        console.log('Payment succeeded!')
        console.log('Use following token for server-side charging:', token.id)
        console.log('Use following booking ID for updating timekit:', window.timekitBookingResponse.data.id)
        // Set variable to check in close callback
        window.paymentHasSucceeded = true
        // Show success page
        window.whenPaymentSucceeds()
      }

      // If stripe checkout is closed (after success or not)
      window.whenStripeIsClosed = function () {
        // Show error if payment was cancelled
        if (!window.paymentHasSucceeded) window.whenPaymentFails()
      }

      // Setup Stripe
      window.stripeHandler = StripeCheckout.configure({
        key: 'pk_test_SoI5ZMlEFTyjlH93kr4JD5Y4',
        image: 'https://stripe.com/img/documentation/checkout/marketplace.png',
        locale: 'auto',
        token: window.whenStripeSucceeds,
        closed: window.whenStripeIsClosed
      });

      // When Timekit booking is created
      window.whenBookingIsCreated = function(response) {
        // Open Stripe checkout window
        window.stripeHandler.open({
          name: 'Doc Brown',
          description: 'Bikram Yoga class',
          amount: 2000
        });
        // Save booking data
        window.timekitBookingResponse = response
        // Return a promise that decides if success page is shown
        return new Promise(function(resolve, reject) {
          window.whenPaymentSucceeds = resolve
          window.whenPaymentFails = reject
        })
      }

      // Init booking.js
      TimekitBooking().init({
        name:     'Doc Brown',
        email:    'timebirdcphtest@gmail.com',
        apiToken: 'password',
        calendar: '31078529-08db-4778-a21e-2bc8ddff806e',
        avatar:   '../misc/avatar-doc.jpg',
        bookingGraph: 'group_customer_payment',
        timekitConfig: {
          app: 'admin',
          apiBaseUrl: 'http://api-localhost.timekit.io/'
        },
        callbacks: {
          createBookingSuccessful: window.whenBookingIsCreated
        }
      });
    </script>
  </div>

  <pre><code>
    curl https://api.stripe.com/v1/charges \
     -u sk_test_GxmHLHa4LLfP9ZJl8IMnhVXD: \
     -d amount=2000 \
     -d currency=usd \
     -d source=tok_18xxft2eZvKYlo2C9Lk487cb \
     -d description="Charge for Timekit group booking"
  </code></pre>
  <pre><code>
    curl http://api-localhost.timekit.io/v2/bookings/123/pay \
     -X PUT \
     -H 'Timekit-App: admin' \
     -H 'Content-Type: application/json' \
     -u timebirdcphtest@gmail.com:password \
     -d '{"pay": {"payment_id": "123" }}'
  </code></pre>

</body>
</html>
